<%- include('partials/header') %>

<section class="page-header">
  <div class="container">
    <div class="page-badge">
      <span class="badge-dot"></span>
      Checkout
    </div>
    <h1 class="page-title">
      Complete Your <span class="gradient-text">Order</span>
    </h1>
  </div>
</section>

<section class="checkout-section">
  <div class="container">
    <div class="checkout-wrapper">
      <!-- Form -->
      <div class="checkout-form">
        <div class="form-header">
          <i class="fas fa-user-circle"></i>
          <h3>Data Pembeli</h3>
        </div>
        
        <div class="form-body">
          <form id="checkoutForm">
            <div class="form-group">
              <label for="username">
                <i class="fas fa-user"></i>
                Username Panel
              </label>
              <input 
                type="text" 
                id="username" 
                name="username" 
                class="form-input"
                placeholder="contoh: nabilganteng"
                required
                pattern="[a-z0-9]{3,16}"
                autocomplete="off"
              >
              <small class="form-hint">
                <i class="fas fa-info-circle"></i>
                3-16 karakter, huruf kecil dan angka saja
              </small>
            </div>

            <div class="form-group">
              <label for="email">
                <i class="fas fa-envelope"></i>
                Email Address
              </label>
              <input 
                type="email" 
                id="email" 
                name="email" 
                class="form-input"
                placeholder="email@example.com"
                required
                autocomplete="email"
              >
              <small class="form-hint">
                <i class="fas fa-info-circle"></i>
                Data akses akan dikirim ke email ini
              </small>
            </div>

            <!-- Turnstile -->
            <div class="turnstile-container" id="turnstileContainer">
              <div class="cf-turnstile" 
                   data-sitekey="0x4AAAAAACadjJKUdbdtyOV5" 
                   data-theme="dark"
                   data-callback="onTurnstileSuccess"
                   data-error-callback="onTurnstileError"
                   data-expired-callback="onTurnstileExpired">
              </div>
              <div id="turnstileStatus" class="turnstile-status">
                <i class="fas fa-shield-alt"></i> Menunggu verifikasi...
              </div>
            </div>

            <label class="checkbox-group">
              <input type="checkbox" id="agree" required>
              <span class="checkmark"></span>
              <span class="checkbox-text">Saya setuju dengan syarat dan ketentuan yang berlaku</span>
            </label>

            <button type="submit" class="btn btn-primary btn-block btn-lg" id="submitBtn" disabled style="margin-top: 24px;">
              <span>Proceed to Payment</span>
              <i class="fas fa-arrow-right"></i>
            </button>
            
            <div style="margin-top: 16px; text-align: center;">
              <small style="color: var(--text-muted); font-size: 0.8rem;">
                <i class="fas fa-lock"></i> Transaksi aman dilindungi SSL & Cloudflare
              </small>
            </div>
          </form>
        </div>
      </div>

      <!-- Summary -->
      <div class="order-summary">
        <div class="summary-card">
          <div class="summary-header">
            <h3><i class="fas fa-receipt"></i> Order Summary</h3>
          </div>
          
          <div class="summary-body">
            <div class="summary-plan">
              <div class="summary-icon">
                <i class="fas fa-<%= plan.id === 'unlimited' ? 'infinity' : 'server' %>"></i>
              </div>
              <h4><%= plan.name %></h4>
              <div class="summary-price">Rp <%= plan.price.toLocaleString('id-ID') %></div>
            </div>

            <div class="summary-specs">
              <div class="summary-row">
                <span><i class="fas fa-memory"></i> RAM</span>
                <span><%= plan.specs.ram === 0 ? 'Unlimited' : plan.specs.ram + ' MB' %></span>
              </div>
              <div class="summary-row">
                <span><i class="fas fa-hdd"></i> Storage</span>
                <span><%= plan.specs.disk === 0 ? 'Unlimited' : plan.specs.disk + ' MB' %></span>
              </div>
              <div class="summary-row">
                <span><i class="fas fa-microchip"></i> CPU</span>
                <span><%= plan.specs.cpu === 0 ? 'Unlimited' : plan.specs.cpu + '%' %></span>
              </div>
              <div class="summary-row">
                <span><i class="fas fa-shield-halved"></i> Protection</span>
                <span>Anti-DDoS</span>
              </div>
            </div>

            <div class="summary-total">
              <span>Total</span>
              <span>Rp <%= plan.price.toLocaleString('id-ID') %></span>
            </div>

            <div class="payment-methods">
              <h4>Metode Pembayaran</h4>
              <div class="payment-icons">
                <div class="payment-icon"><i class="fas fa-qrcode"></i></div>
                <div class="payment-icon"><i class="fas fa-wallet"></i></div>
                <div class="payment-icon"><i class="fas fa-mobile-alt"></i></div>
                <div class="payment-icon"><i class="fas fa-university"></i></div>
              </div>
              <p style="margin-top: 12px; font-size: 0.85rem; color: var(--text-muted); text-align: center;">
                <i class="fas fa-info-circle"></i> QRIS (All Payment)
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<script>
  window.isVerified = false;
  window.turnstileToken = null;

  function onTurnstileSuccess(token) {
    window.isVerified = true;
    window.turnstileToken = token;
    document.getElementById('submitBtn').disabled = false;
    document.getElementById('turnstileStatus').innerHTML = 
      '<i class="fas fa-check-circle" style="color: #22c55e;"></i> Verifikasi Berhasil';
  }

  function onTurnstileError() {
    window.isVerified = false;
    document.getElementById('submitBtn').disabled = true;
    document.getElementById('turnstileStatus').innerHTML = 
      '<i class="fas fa-times-circle" style="color: #ef4444;"></i> Gagal memuat';
  }

  function onTurnstileExpired() {
    window.isVerified = false;
    document.getElementById('submitBtn').disabled = true;
    document.getElementById('turnstileStatus').innerHTML = 
      '<i class="fas fa-exclamation-triangle" style="color: #eab308;"></i> Kadaluarsa';
  }

  // Input filter
  document.getElementById('username').addEventListener('input', function(e) {
    this.value = this.value.toLowerCase().replace(/[^a-z0-9]/g, '').substring(0, 16);
  });

  // Form submit
  document.getElementById('checkoutForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const username = document.getElementById('username').value.trim();
    const email = document.getElementById('email').value.trim();
    const agree = document.getElementById('agree').checked;
    
    if (!agree) {
      showToast('Harap setujui syarat & ketentuan', 'error');
      return;
    }

    const formData = new FormData(e.target);
    const token = formData.get('cf-turnstile-response') || window.turnstileToken;

    if (!token) {
      showToast('Silakan verifikasi keamanan', 'error');
      return;
    }
    
    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Memproses...</span>';
    
    try {
      const response = await fetch('/api/payment/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          plan: '<%= plan.id %>',
          username,
          email,
          recaptchaResponse: token
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        showToast('Order berhasil dibuat!', 'success');
        setTimeout(() => {
          sessionStorage.setItem('paymentData', JSON.stringify(data));
          window.location.href = `/payment/${data.orderId}`;
        }, 1500);
      } else {
        throw new Error(data.message || 'Gagal membuat order');
      }
    } catch (err) {
      showToast(err.message || 'Koneksi bermasalah', 'error');
      btn.disabled = false;
      btn.innerHTML = '<span>Proceed to Payment</span><i class="fas fa-arrow-right"></i>';
      if (window.turnstile) window.turnstile.reset();
    }
  });
</script>

<%- include('partials/footer') %>
